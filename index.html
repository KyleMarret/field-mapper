<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>KAS Field Sampler</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background: #f0f0f0;
        }
        
        #map {
            height: 100vh;
            width: 100vw;
        }
        
        /* Main Control Panel */
        .control-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            width: 320px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            font-size: 18px;
        }
        
        .panel-section {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .panel-section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        /* Buttons */
        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin: 4px 0;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .btn-warning {
            background: #ed8936;
            color: white;
        }
        
        .btn-warning:hover {
            background: #dd6b20;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .btn-outline {
            background: white;
            color: #667eea;
            border: 1px solid #667eea;
        }
        
        .btn-outline:hover {
            background: #667eea;
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 8px;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        /* Field List */
        .field-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .field-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .field-item:hover {
            background: #e9ecef;
        }
        
        .field-item.active {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .field-name {
            font-weight: 500;
            color: #333;
        }
        
        .field-details {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        /* Layer Controls */
        .layer-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 200px;
        }
        
        .layer-controls h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #333;
        }
        
        .layer-toggle {
            display: flex;
            align-items: center;
            margin: 8px 0;
            cursor: pointer;
        }
        
        .layer-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
        }
        
        .layer-toggle label {
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 70px;
            left: 10px;
            background: white;
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
        }
        
        .status-item {
            display: inline-block;
            margin-right: 15px;
        }
        
        .status-label {
            color: #666;
            margin-right: 5px;
        }
        
        .status-value {
            font-weight: 600;
            color: #333;
        }
        
        /* Toolbar */
        .toolbar {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 30px;
            padding: 10px 20px;
            display: flex;
            gap: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .tool-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .tool-btn.active {
            background: #667eea;
            color: white;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 50%;
            transform: translateX(50%);
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 9999;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .toast.show {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(50%) translateY(-100%);
            }
            to {
                transform: translateX(50%) translateY(0);
            }
        }
        
        /* File Upload */
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            left: -9999px;
        }
        
        .file-upload-label {
            display: block;
            padding: 10px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
        }
        
        .file-upload-label:hover {
            background: #e9ecef;
            border-color: #667eea;
            color: #667eea;
        }
        
        /* No data message */
        .no-data {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
    
    <!-- Main Control Panel -->
    <div class="control-panel">
        <div class="panel-header">
            KAS Field Sampler
        </div>
        
        <!-- Grower Section -->
        <div class="panel-section">
            <div class="section-title">Grower Information</div>
            <div class="form-group">
                <label class="form-label">Select Grower</label>
                <select class="form-select" id="growerSelect" onchange="selectGrower()">
                    <option value="">-- Select or Add New --</option>
                </select>
            </div>
            <div class="btn-group">
                <button class="btn btn-outline" onclick="showAddGrower()">+ Add</button>
                <button class="btn btn-outline" onclick="editGrower()">Edit</button>
                <button class="btn btn-outline" onclick="deleteGrower()">Delete</button>
            </div>
        </div>
        
        <!-- Field Section -->
        <div class="panel-section" id="fieldSection" style="display: none;">
            <div class="section-title">Field Management</div>
            <div class="field-list" id="fieldList">
                <div class="no-data">No fields added yet</div>
            </div>
            <button class="btn btn-primary" onclick="showAddField()">+ Add New Field</button>
            <button class="btn btn-success" id="drawFieldBtn" onclick="drawFieldBoundary()">Draw Field Boundary</button>
        </div>
        
        <!-- Sampling Section -->
        <div class="panel-section" id="samplingSection" style="display: none;">
            <div class="section-title">Sampling</div>
            <div class="form-group">
                <label class="form-label">Active Field: <span id="activeFieldName" style="color: #667eea; font-weight: 600;">None</span></label>
            </div>
            <button class="btn btn-warning" onclick="startSampling()">Start Sampling</button>
            <div class="form-group" style="margin-top: 10px;">
                <label class="form-label">Sample Count: <span id="sampleCount" style="font-weight: 600;">0</span></label>
            </div>
        </div>
        
        <!-- Export Section -->
        <div class="panel-section" id="exportSection" style="display: none;">
            <div class="section-title">Data Export</div>
            <button class="btn btn-success" onclick="exportCSV()">Export to CSV</button>
            <button class="btn btn-outline" onclick="saveToLocal()">Save to Browser</button>
            <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
        </div>
    </div>
    
    <!-- Layer Controls -->
    <div class="layer-controls">
        <h4>Map Layers</h4>
        <div class="layer-toggle">
            <input type="checkbox" id="soilToggle" onchange="toggleSoilLayer()">
            <label for="soilToggle">SSURGO Soil Data</label>
        </div>
        <div class="layer-toggle">
            <input type="checkbox" id="boundaryToggle" checked onchange="toggleBoundaries()">
            <label for="boundaryToggle">Field Boundaries</label>
        </div>
        <div class="layer-toggle">
            <input type="checkbox" id="sampleToggle" checked onchange="toggleSamples()">
            <label for="sampleToggle">Sample Points</label>
        </div>
        <div class="layer-toggle">
            <input type="checkbox" id="satelliteToggle" checked onchange="toggleMapType()">
            <label for="satelliteToggle">Satellite View</label>
        </div>
        <hr style="margin: 10px 0;">
        <div class="file-upload">
            <input type="file" id="soilUpload" accept=".json,.geojson,.kml">
            <label for="soilUpload" class="file-upload-label">
                📁 Load Soil Data (JSON/KML)
            </label>
        </div>
        <div style="margin-top: 5px; font-size: 11px; color: #666;" id="soilStatus">No soil data loaded</div>
        <div style="margin-top: 8px; padding: 8px; background: #fff9e6; border-radius: 4px; font-size: 11px; color: #856404; border: 1px solid #ffd966;">
            <b>Note:</b> MUSYM codes vary by county. The soil series names shown are estimates. Check Web Soil Survey for exact interpretations.
        </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
        <span class="status-item">
            <span class="status-label">GPS:</span>
            <span class="status-value" id="gpsStatus">Waiting...</span>
        </span>
        <span class="status-item">
            <span class="status-label">Grower:</span>
            <span class="status-value" id="currentGrower">None</span>
        </span>
        <span class="status-item">
            <span class="status-label">Field:</span>
            <span class="status-value" id="currentField">None</span>
        </span>
    </div>
    
    <!-- Toolbar -->
    <div class="toolbar">
        <button class="tool-btn" onclick="centerOnGPS()" title="Center on GPS">📍</button>
        <button class="tool-btn" id="dropPinBtn" onclick="dropPin()" title="Drop Sample Pin">🎯</button>
        <button class="tool-btn" onclick="zoomIn()" title="Zoom In">➕</button>
        <button class="tool-btn" onclick="zoomOut()" title="Zoom Out">➖</button>
        <button class="tool-btn" onclick="zoomToField()" title="Zoom to Field">🔍</button>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    
    <script>
        // Global variables
        let map;
        let currentLocation = null;
        let locationMarker = null;
        let soilLayer = null;
        let soilData = null;
        let drawControl = null;
        let isDrawing = false;
        let isSampling = false;
        
        // Data structures
        let growers = {};
        let currentGrowerId = null;
        let currentFieldId = null;
        let fieldBoundaries = {};
        let sampleMarkers = [];
        
        // Initialize map
        function initMap() {
            // Start with a wider US view until GPS or soil data loads
            map = L.map('map').setView([38.5, -90.5], 10); // Missouri/Illinois border area
            
            // Map layers
            const satellite = L.tileLayer('https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                maxZoom: 22,
                attribution: '© Google'
            }).addTo(map);
            
            const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 20,
                attribution: '© OpenStreetMap'
            });
            
            window.mapLayers = { satellite, streets, current: 'satellite' };
            
            // Start GPS tracking
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(updateGPS, handleGPSError, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            }
            
            // Setup file upload
            document.getElementById('soilUpload').addEventListener('change', handleSoilUpload);
            
            // Load saved data
            loadSavedData();
        }
        
        // GPS functions
        function updateGPS(position) {
            currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
            };
            
            document.getElementById('gpsStatus').textContent = 
                `${currentLocation.lat.toFixed(5)}, ${currentLocation.lng.toFixed(5)}`;
            
            if (locationMarker) {
                locationMarker.setLatLng([currentLocation.lat, currentLocation.lng]);
            } else {
                locationMarker = L.circleMarker([currentLocation.lat, currentLocation.lng], {
                    radius: 8,
                    fillColor: '#007AFF',
                    color: 'white',
                    weight: 3,
                    fillOpacity: 1,
                    zIndexOffset: 1000
                }).addTo(map);
            }
        }
        
        function handleGPSError(error) {
            document.getElementById('gpsStatus').textContent = 'GPS unavailable';
            console.error('GPS Error:', error);
        }
        
        // Grower Management
        function selectGrower() {
            const select = document.getElementById('growerSelect');
            currentGrowerId = select.value;
            
            if (currentGrowerId) {
                document.getElementById('currentGrower').textContent = growers[currentGrowerId].name;
                document.getElementById('fieldSection').style.display = 'block';
                document.getElementById('samplingSection').style.display = 'block';
                document.getElementById('exportSection').style.display = 'block';
                updateFieldList();
            } else {
                document.getElementById('currentGrower').textContent = 'None';
                document.getElementById('fieldSection').style.display = 'none';
                document.getElementById('samplingSection').style.display = 'none';
                document.getElementById('exportSection').style.display = 'none';
                currentFieldId = null;
            }
        }
        
        function showAddGrower() {
            const name = prompt('Enter grower name:');
            if (name) {
                const id = 'grower_' + Date.now();
                growers[id] = {
                    id: id,
                    name: name,
                    fields: {},
                    created: new Date().toISOString()
                };
                updateGrowerSelect();
                document.getElementById('growerSelect').value = id;
                selectGrower();
                saveData();
                showToast(`Grower "${name}" added`);
            }
        }
        
        function editGrower() {
            if (!currentGrowerId) {
                alert('Please select a grower first');
                return;
            }
            const newName = prompt('Edit grower name:', growers[currentGrowerId].name);
            if (newName) {
                growers[currentGrowerId].name = newName;
                updateGrowerSelect();
                selectGrower();
                saveData();
                showToast('Grower updated');
            }
        }
        
        function deleteGrower() {
            if (!currentGrowerId) {
                alert('Please select a grower first');
                return;
            }
            if (confirm(`Delete grower "${growers[currentGrowerId].name}" and all fields?`)) {
                // Remove all field boundaries from map
                const fields = growers[currentGrowerId].fields;
                for (let fieldId in fields) {
                    if (fieldBoundaries[fieldId]) {
                        map.removeLayer(fieldBoundaries[fieldId]);
                        delete fieldBoundaries[fieldId];
                    }
                }
                
                delete growers[currentGrowerId];
                currentGrowerId = null;
                currentFieldId = null;
                updateGrowerSelect();
                selectGrower();
                saveData();
                showToast('Grower deleted');
            }
        }
        
        function updateGrowerSelect() {
            const select = document.getElementById('growerSelect');
            select.innerHTML = '<option value="">-- Select or Add New --</option>';
            
            for (let id in growers) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = growers[id].name;
                select.appendChild(option);
            }
        }
        
        // Field Management
        function showAddField() {
            if (!currentGrowerId) {
                alert('Please select a grower first');
                return;
            }
            
            const name = prompt('Enter field name (e.g., North Block, Vineyard A):');
            if (name) {
                const acres = prompt('Enter approximate acres (optional):');
                const id = 'field_' + Date.now();
                
                growers[currentGrowerId].fields[id] = {
                    id: id,
                    name: name,
                    acres: acres || '',
                    boundary: null,
                    samples: [],
                    created: new Date().toISOString()
                };
                
                updateFieldList();
                selectField(id);
                saveData();
                showToast(`Field "${name}" added`);
            }
        }
        
        function updateFieldList() {
            const container = document.getElementById('fieldList');
            const fields = growers[currentGrowerId]?.fields || {};
            const fieldIds = Object.keys(fields);
            
            if (fieldIds.length === 0) {
                container.innerHTML = '<div class="no-data">No fields added yet</div>';
                return;
            }
            
            container.innerHTML = fieldIds.map(id => {
                const field = fields[id];
                const isActive = currentFieldId === id;
                return `
                    <div class="field-item ${isActive ? 'active' : ''}" onclick="selectField('${id}')">
                        <div class="field-name">${field.name}</div>
                        <div class="field-details">
                            ${field.acres ? field.acres + ' acres' : 'No acreage set'}
                            ${field.boundary ? ' • Boundary set' : ''}
                            ${field.samples?.length > 0 ? ' • ' + field.samples.length + ' samples' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectField(fieldId) {
            currentFieldId = fieldId;
            const field = growers[currentGrowerId].fields[fieldId];
            
            document.getElementById('currentField').textContent = field.name;
            document.getElementById('activeFieldName').textContent = field.name;
            
            updateFieldList();
            
            // Hide other boundaries, show this one
            for (let id in fieldBoundaries) {
                if (fieldBoundaries[id]) {
                    if (id === fieldId) {
                        fieldBoundaries[id].addTo(map);
                    } else {
                        map.removeLayer(fieldBoundaries[id]);
                    }
                }
            }
            
            // Zoom to field if it has a boundary
            if (fieldBoundaries[fieldId]) {
                map.fitBounds(fieldBoundaries[fieldId].getBounds(), { padding: [50, 50] });
            }
        }
        
        function drawFieldBoundary() {
            if (!currentFieldId) {
                alert('Please select a field first');
                return;
            }
            
            if (isDrawing) {
                // Cancel drawing
                if (drawControl) drawControl.disable();
                isDrawing = false;
                document.getElementById('drawFieldBtn').textContent = 'Draw Field Boundary';
                document.getElementById('drawFieldBtn').classList.remove('btn-danger');
                document.getElementById('drawFieldBtn').classList.add('btn-success');
                return;
            }
            
            isDrawing = true;
            document.getElementById('drawFieldBtn').textContent = 'Cancel Drawing';
            document.getElementById('drawFieldBtn').classList.remove('btn-success');
            document.getElementById('drawFieldBtn').classList.add('btn-danger');
            
            drawControl = new L.Draw.Polygon(map, {
                shapeOptions: {
                    color: '#667eea',
                    weight: 4,  // Thicker boundary lines
                    fillOpacity: 0.15,
                    dashArray: '10, 5'  // Dashed line for visibility
                }
            });
            
            drawControl.enable();
            
            map.once('draw:created', function(e) {
                const layer = e.layer;
                
                // Remove old boundary if exists
                if (fieldBoundaries[currentFieldId]) {
                    map.removeLayer(fieldBoundaries[currentFieldId]);
                }
                
                // Save new boundary
                fieldBoundaries[currentFieldId] = layer;
                layer.addTo(map);
                
                // Save coordinates to field data
                const coords = layer.getLatLngs()[0].map(ll => ({
                    lat: ll.lat,
                    lng: ll.lng
                }));
                growers[currentGrowerId].fields[currentFieldId].boundary = coords;
                
                isDrawing = false;
                document.getElementById('drawFieldBtn').textContent = 'Draw Field Boundary';
                document.getElementById('drawFieldBtn').classList.remove('btn-danger');
                document.getElementById('drawFieldBtn').classList.add('btn-success');
                
                updateFieldList();
                saveData();
                showToast('Field boundary saved');
            });
        }
        
        function zoomToField() {
            if (currentFieldId && fieldBoundaries[currentFieldId]) {
                map.fitBounds(fieldBoundaries[currentFieldId].getBounds(), { padding: [50, 50] });
            } else {
                showToast('No field boundary to zoom to');
            }
        }
        
        // Sampling
        function startSampling() {
            if (!currentFieldId) {
                alert('Please select a field first');
                return;
            }
            
            isSampling = !isSampling;
            const btn = document.querySelector('.btn-warning');
            
            if (isSampling) {
                btn.textContent = 'Stop Sampling';
                btn.classList.add('btn-danger');
                btn.classList.remove('btn-warning');
                document.getElementById('dropPinBtn').classList.add('active');
                showToast('Sampling mode active - Click 🎯 to drop pins');
            } else {
                btn.textContent = 'Start Sampling';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-warning');
                document.getElementById('dropPinBtn').classList.remove('active');
                showToast('Sampling mode stopped');
            }
        }
        
        function dropPin() {
            if (!isSampling) {
                showToast('Start sampling mode first');
                return;
            }
            
            if (!currentFieldId) {
                showToast('Select a field first');
                return;
            }
            
            if (!currentLocation) {
                // Manual placement
                showToast('Click on map to place pin');
                map.once('click', function(e) {
                    placeSamplePin(e.latlng.lat, e.latlng.lng, true);
                });
                return;
            }
            
            placeSamplePin(currentLocation.lat, currentLocation.lng, false);
        }
        
        function placeSamplePin(lat, lng, isManual) {
            // Detect soil type if soil layer is loaded
            let soilType = '';
            let soilInfo = null;
            
            if (soilLayer) {
                const point = L.latLng(lat, lng);
                let foundSoil = false;
                
                soilLayer.eachLayer(function(layer) {
                    // More robust point-in-polygon check
                    if (!foundSoil && layer.getBounds && layer.getBounds().contains(point)) {
                        // Do a more precise check if possible
                        if (layer.soilData) {
                            soilType = layer.soilData.MUSYM || '';
                            soilInfo = getSoilInfo(soilType);
                            foundSoil = true;
                        }
                    }
                });
            }
            
            const field = growers[currentGrowerId].fields[currentFieldId];
            const sampleNum = (field.samples?.length || 0) + 1;
            
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    html: `<div style="background: #ed8936; color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${sampleNum}</div>`,
                    iconSize: [26, 26],
                    iconAnchor: [13, 13]
                })
            }).addTo(map);
            
            let popupContent = '<div style="min-width: 180px;">';
            popupContent += `<h4 style="margin: 0 0 5px 0; color: #ed8936;">Sample #${sampleNum}</h4>`;
            popupContent += `<b>Field:</b> ${field.name}<br>`;
            if (soilType) {
                popupContent += `<b>Soil Unit:</b> ${soilType}<br>`;
                if (soilInfo) {
                    popupContent += `<b>Series:</b> ${soilInfo.series}<br>`;
                    popupContent += `<b>Texture:</b> ${soilInfo.texture}<br>`;
                }
            }
            popupContent += `<b>GPS:</b> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>`;
            popupContent += `<b>Time:</b> ${new Date().toLocaleString()}<br>`;
            if (isManual) popupContent += `<i style="color: #666;">Manual placement</i>`;
            popupContent += '</div>';
            
            marker.bindPopup(popupContent);
            
            // Save sample data
            const sample = {
                id: 'sample_' + Date.now(),
                number: sampleNum,
                lat: lat,
                lng: lng,
                soilType: soilType,
                soilInfo: soilInfo,
                timestamp: new Date().toISOString(),
                isManual: isManual
            };
            
            if (!field.samples) field.samples = [];
            field.samples.push(sample);
            
            sampleMarkers.push({ marker: marker, fieldId: currentFieldId, sample: sample });
            
            document.getElementById('sampleCount').textContent = field.samples.length;
            
            saveData();
            showToast(`Sample #${sampleNum} placed${soilType ? ' - Soil: ' + soilType : ''}`);
        }
        
        // Soil Data Management
        function handleSoilUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('soilStatus').textContent = 'Loading...';
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const content = event.target.result;
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.json') || fileName.endsWith('.geojson')) {
                    loadSoilGeoJSON(content);
                } else if (fileName.endsWith('.kml')) {
                    loadSoilKML(content);
                }
            };
            reader.readAsText(file);
        }
        
        function loadSoilGeoJSON(jsonString) {
            try {
                const geoData = JSON.parse(jsonString);
                soilData = geoData;
                
                if (soilLayer) {
                    map.removeLayer(soilLayer);
                }
                
                // Create color map for different soil types
                const colorMap = {};
                const baseColors = ['#8B4513', '#CD853F', '#DEB887', '#F4A460', '#D2691E', '#BC8F8F', '#DAA520', '#B8860B'];
                let colorIndex = 0;
                
                // Assign colors to each unique MUSYM
                geoData.features.forEach(feature => {
                    const musym = feature.properties.MUSYM;
                    if (musym && !colorMap[musym]) {
                        colorMap[musym] = baseColors[colorIndex % baseColors.length];
                        colorIndex++;
                    }
                });
                
                soilLayer = L.geoJSON(geoData, {
                    style: function(feature) {
                        const musym = feature.properties.MUSYM || '';
                        return {
                            fillColor: colorMap[musym] || '#BC8F8F',
                            weight: 3,  // Thicker borders
                            opacity: 1,
                            color: '#000',  // Black borders for visibility
                            fillOpacity: 0.4,
                            dashArray: ''
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        layer.soilData = feature.properties;
                        
                        // Build comprehensive popup with edit capability
                        let popup = '<div style="min-width: 200px; font-size: 13px;">';
                        popup += '<h4 style="margin: 0 0 8px 0; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 4px;">Soil Information</h4>';
                        
                        if (feature.properties.MUSYM) {
                            popup += `<b>Map Unit Symbol:</b> ${feature.properties.MUSYM}<br>`;
                        }
                        if (feature.properties.MUKEY) {
                            popup += `<b>MUKEY:</b> ${feature.properties.MUKEY}<br>`;
                        }
                        if (feature.properties.AREASYMBOL) {
                            popup += `<b>Survey Area:</b> ${feature.properties.AREASYMBOL}<br>`;
                        }
                        
                        // Get soil info from our database
                        const info = getSoilInfo(feature.properties.MUSYM);
                        if (info) {
                            popup += `<hr style="margin: 8px 0;">`;
                            if (info.series && !info.series.includes('Map Unit')) {
                                popup += `<b>Soil Series:</b> ${info.series}<br>`;
                                popup += `<b>Texture:</b> ${info.texture}<br>`;
                                popup += `<b>Drainage:</b> ${info.drainage}<br>`;
                                popup += `<b>Slope:</b> ${info.slope}<br>`;
                                if (info.ph) popup += `<b>pH Range:</b> ${info.ph}<br>`;
                                if (info.notes) popup += `<b>Notes:</b> <i>${info.notes}</i><br>`;
                            } else {
                                popup += `<i>Soil series not identified for ${feature.properties.MUSYM}</i><br>`;
                                popup += `<small>Check Web Soil Survey for interpretation</small><br>`;
                            }
                        }
                        
                        popup += `<hr style="margin: 8px 0;">`;
                        popup += `<small><a href="https://websoilsurvey.nrcs.usda.gov/" target="_blank">Look up on Web Soil Survey →</a></small>`;
                        popup += '</div>';
                        
                        layer.bindPopup(popup);
                    }
                });
                
                // Add to map if toggle is on, otherwise just store it
                if (document.getElementById('soilToggle').checked) {
                    soilLayer.addTo(map);
                }
                
                // Auto-zoom to loaded data
                const bounds = soilLayer.getBounds();
                map.fitBounds(bounds, { padding: [50, 50] });
                
                // Count features and soil types
                let featureCount = 0;
                const uniqueSoilTypes = new Set();
                geoData.features.forEach(f => {
                    featureCount++;
                    if (f.properties.MUSYM) {
                        uniqueSoilTypes.add(f.properties.MUSYM);
                    }
                });
                
                document.getElementById('soilStatus').textContent = `✓ ${featureCount} polygons, ${uniqueSoilTypes.size} soil types`;
                
                // Show notification with soil types found
                const soilTypesList = Array.from(uniqueSoilTypes).join(', ');
                showToast(`Loaded ${featureCount} soil polygons: ${soilTypesList}`);
                
                // Auto-enable the soil layer toggle so user can see it loaded
                if (!document.getElementById('soilToggle').checked) {
                    document.getElementById('soilToggle').checked = true;
                    soilLayer.addTo(map);
                }
                
            } catch (error) {
                document.getElementById('soilStatus').textContent = 'Error loading file';
                console.error(error);
                showToast('Error loading soil data');
            }
        }
        
        function loadSoilKML(kmlContent) {
            // Similar to GeoJSON but for KML
            try {
                if (soilLayer) {
                    map.removeLayer(soilLayer);
                }
                
                soilLayer = omnivore.kml.parse(kmlContent);
                
                if (document.getElementById('soilToggle').checked) {
                    soilLayer.addTo(map);
                }
                
                document.getElementById('soilStatus').textContent = '✓ KML loaded';
                showToast('KML data loaded');
            } catch (error) {
                document.getElementById('soilStatus').textContent = 'Error loading KML';
            }
        }
        
        function getSoilInfo(musym) {
            // IMPORTANT: MUSYM codes are specific to each county/survey area
            // The series names below should be verified with Web Soil Survey for your specific area
            // To get correct names:
            // 1. Go to Web Soil Survey
            // 2. Look up your area
            // 3. Check "Soil Map" tab
            // 4. Click "Map Unit Legend" to see MUSYM to series mapping
            
            const soilData = {
                // Illinois soils (Union County - IL181) - Alto Vineyard
                // Corrected based on user feedback: These are Menfro series, not Darwin
                '79B': { 
                    series: 'Menfro silt loam', 
                    texture: 'Silt loam', 
                    drainage: 'Well drained', 
                    slope: '0-2% slopes',
                    ph: '5.5-7.3',
                    notes: 'Deep, well-drained loess soils'
                },
                '79C2': { 
                    series: 'Menfro silt loam', 
                    texture: 'Silt loam', 
                    drainage: 'Well drained', 
                    slope: '2-5% slopes, eroded',
                    ph: '5.5-7.3',
                    notes: 'Good for vineyards with proper erosion control'
                },
                '79D2': { 
                    series: 'Menfro silt loam', 
                    texture: 'Silt loam', 
                    drainage: 'Well drained', 
                    slope: '5-10% slopes, eroded',
                    ph: '5.5-7.3',
                    notes: 'Steeper slopes, manage erosion'
                },
                '79D3': { 
                    series: 'Menfro silt loam', 
                    texture: 'Silt loam', 
                    drainage: 'Well drained', 
                    slope: '5-10% slopes, severely eroded',
                    ph: '5.5-7.3',
                    notes: 'Severely eroded, may need restoration'
                },
                '79E2': { 
                    series: 'Menfro silt loam', 
                    texture: 'Silt loam', 
                    drainage: 'Well drained', 
                    slope: '10-15% slopes, eroded',
                    ph: '5.5-7.3',
                    notes: 'Steep slopes, erosion concern'
                },
                
                // Missouri soils (Perry County - MO201) - KFV
                // Corrected based on user feedback: These are Memphis series
                '90601': {
                    series: 'Memphis silt loam',
                    texture: 'Silt loam',
                    drainage: 'Well drained',
                    slope: '0-2% slopes',
                    ph: '5.1-6.5',
                    notes: 'Deep, well-drained loess soils, excellent for vineyards'
                },
                '90021': {
                    series: 'Memphis silt loam',
                    texture: 'Silt loam',
                    drainage: 'Well drained',
                    slope: '2-5% slopes',
                    ph: '5.1-6.5',
                    notes: 'Good agricultural soil, moderate slope'
                },
                '90017': {
                    series: 'Memphis silt loam',
                    texture: 'Silt loam',
                    drainage: 'Well drained',
                    slope: '0-2% slopes',
                    ph: '5.1-6.5',
                    notes: 'Prime farmland when not flooded'
                }
            };
            
            // Return the soil info if found, otherwise return a generic message
            if (soilData[musym]) {
                return soilData[musym];
            } else {
                // For unknown MUSYM codes, return basic info
                return {
                    series: `Map Unit ${musym}`,
                    texture: 'See Web Soil Survey',
                    drainage: 'See Web Soil Survey',
                    slope: 'Varies',
                    notes: 'Check SSURGO data tables or Web Soil Survey for detailed interpretation'
                };
            }
        }
        
        // Layer Toggles
        function toggleSoilLayer() {
            if (!soilLayer) {
                showToast('No soil data loaded');
                document.getElementById('soilToggle').checked = false;
                return;
            }
            
            if (document.getElementById('soilToggle').checked) {
                soilLayer.addTo(map);
            } else {
                map.removeLayer(soilLayer);
            }
        }
        
        function toggleBoundaries() {
            const show = document.getElementById('boundaryToggle').checked;
            for (let id in fieldBoundaries) {
                if (fieldBoundaries[id]) {
                    if (show && (id === currentFieldId || !currentFieldId)) {
                        fieldBoundaries[id].addTo(map);
                    } else {
                        map.removeLayer(fieldBoundaries[id]);
                    }
                }
            }
        }
        
        function toggleSamples() {
            const show = document.getElementById('sampleToggle').checked;
            sampleMarkers.forEach(item => {
                if (show) {
                    item.marker.addTo(map);
                } else {
                    map.removeLayer(item.marker);
                }
            });
        }
        
        function toggleMapType() {
            const useSatellite = document.getElementById('satelliteToggle').checked;
            if (useSatellite) {
                map.removeLayer(window.mapLayers.streets);
                map.addLayer(window.mapLayers.satellite);
            } else {
                map.removeLayer(window.mapLayers.satellite);
                map.addLayer(window.mapLayers.streets);
            }
        }
        
        // Export Functions
        function exportCSV() {
            if (!currentGrowerId) {
                alert('No grower selected');
                return;
            }
            
            let csv = 'Grower,Field,Sample_Number,Latitude,Longitude,Soil_Unit,Soil_Series,Date_Time\n';
            
            const grower = growers[currentGrowerId];
            for (let fieldId in grower.fields) {
                const field = grower.fields[fieldId];
                if (field.samples) {
                    field.samples.forEach(sample => {
                        csv += `"${grower.name}",`;
                        csv += `"${field.name}",`;
                        csv += `${sample.number},`;
                        csv += `${sample.lat.toFixed(6)},`;
                        csv += `${sample.lng.toFixed(6)},`;
                        csv += `${sample.soilType || ''},`;
                        csv += `"${sample.soilInfo?.series || ''}",`;
                        csv += `"${new Date(sample.timestamp).toLocaleString()}"\n`;
                    });
                }
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `samples_${grower.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('CSV exported successfully');
        }
        
        // Utility Functions
        function centerOnGPS() {
            if (currentLocation) {
                map.setView([currentLocation.lat, currentLocation.lng], 18);
            } else {
                showToast('GPS not available');
            }
        }
        
        function zoomIn() {
            map.zoomIn();
        }
        
        function zoomOut() {
            map.zoomOut();
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Data Persistence
        function saveData() {
            localStorage.setItem('kasFieldData', JSON.stringify({
                growers: growers,
                currentGrowerId: currentGrowerId,
                currentFieldId: currentFieldId
            }));
        }
        
        function loadSavedData() {
            const saved = localStorage.getItem('kasFieldData');
            if (saved) {
                const data = JSON.parse(saved);
                growers = data.growers || {};
                
                // Restore field boundaries
                for (let growerId in growers) {
                    const grower = growers[growerId];
                    for (let fieldId in grower.fields) {
                        const field = grower.fields[fieldId];
                        if (field.boundary) {
                            const coords = field.boundary.map(c => [c.lat, c.lng]);
                            const polygon = L.polygon(coords, {
                                color: '#667eea',
                                weight: 4,
                                fillOpacity: 0.15,
                                dashArray: '10, 5'
                            });
                            fieldBoundaries[fieldId] = polygon;
                        }
                    }
                }
                
                updateGrowerSelect();
                
                // Restore selection if they exist
                if (data.currentGrowerId && growers[data.currentGrowerId]) {
                    document.getElementById('growerSelect').value = data.currentGrowerId;
                    selectGrower();
                    
                    if (data.currentFieldId && growers[data.currentGrowerId].fields[data.currentFieldId]) {
                        selectField(data.currentFieldId);
                    }
                }
            }
        }
        
        function saveToLocal() {
            saveData();
            showToast('Data saved to browser');
        }
        
        function clearAllData() {
            if (!confirm('This will clear ALL growers, fields, and samples. Are you sure?')) {
                return;
            }
            
            // Clear from map
            for (let id in fieldBoundaries) {
                if (fieldBoundaries[id]) {
                    map.removeLayer(fieldBoundaries[id]);
                }
            }
            fieldBoundaries = {};
            
            sampleMarkers.forEach(item => {
                map.removeLayer(item.marker);
            });
            sampleMarkers = [];
            
            // Clear data
            growers = {};
            currentGrowerId = null;
            currentFieldId = null;
            
            // Clear UI
            updateGrowerSelect();
            selectGrower();
            
            // Clear storage
            localStorage.removeItem('kasFieldData');
            
            showToast('All data cleared');
        }
        
        // Initialize on load
        window.addEventListener('load', initMap);
    </script>
</body>
</html>