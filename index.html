<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>KAS Field Sampler v2.0</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    
    <!-- Shapefile processing libraries -->
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/shpjs@4.0.4/dist/shp.min.js"></script>
    <script src="https://unpkg.com/proj4@2.9.0/dist/proj4.js"></script>
    
    <!-- Application Styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="map"></div>
    
    <!-- Sync Status -->
    <div class="sync-status" id="syncStatus">
        <div class="sync-dot"></div>
        <span id="syncStatusText">Connecting...</span>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
    
    <!-- Modal for Editing -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">Edit</div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="modalSaveBtn">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Main Control Panel -->
    <div class="control-panel" id="mainPanel">
        <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
            <span>KAS Field Sampler v2.0</span>
            <button onclick="toggleMainPanel()" style="background: none; border: none; cursor: pointer; font-size: 20px; color: white; padding: 0; width: 24px; height: 24px;" id="mainPanelToggleBtn">
                âˆ’
            </button>
        </div>
        <div id="mainPanelContent">
            <!-- Farm Section -->
            <div class="panel-section">
                <div class="section-title">Farm Management</div>
                <div class="form-group">
                    <label class="form-label">Select Farm</label>
                    <select class="form-select" id="farmSelect" onchange="selectFarm()">
                        <option value="">-- Select or Add New --</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="showAddFarm()">+ Add</button>
                    <button class="btn btn-outline" onclick="editFarm()">âœï¸ Edit</button>
                    <button class="btn btn-outline" onclick="deleteFarm()">ğŸ—‘ï¸ Delete</button>
                </div>
            </div>
            
            <!-- Field Section -->
            <div class="panel-section" id="fieldSection" style="display: none;">
                <div class="section-title">Field Management</div>
                <div class="field-list" id="fieldList">
                    <div class="no-data">No fields added yet</div>
                </div>
                <button class="btn btn-primary" onclick="showAddField()">+ Add New Field</button>
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="editField()">âœï¸ Edit Field</button>
                    <button class="btn btn-outline" onclick="deleteField()">ğŸ—‘ï¸ Delete Field</button>
                </div>
                <button class="btn btn-success" id="drawFieldBtn" onclick="drawFieldBoundary()">ğŸ“ Draw Field Boundary</button>
            </div>
            
            <!-- Sampling Section -->
            <div class="panel-section" id="samplingSection" style="display: none;">
                <div class="section-title">Sampling</div>
                <div class="form-group">
                    <label class="form-label">Active Field: <span id="activeFieldName" style="color: #667eea; font-weight: 600;">None</span></label>
                </div>
                
                <!-- Add Sample Input -->
                <div class="form-group">
                    <label class="form-label">Add Sample</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-input" id="newSampleName" placeholder="e.g., North Section, Area A" style="flex: 1;">
                        <button class="btn btn-primary" onclick="addSamplePlan()" style="width: auto; padding: 10px 20px;">+ Add</button>
                    </div>
                </div>
                
                <!-- Sample List -->
                <div class="form-group">
                    <label class="form-label">Sample Plans</label>
                    <div id="samplePlanList" style="max-height: 200px; overflow-y: auto;">
                        <div class="no-data" style="padding: 15px;">No samples added yet. Click + Add to create samples.</div>
                    </div>
                </div>
                
                <button class="btn btn-warning" onclick="startSampling()">Start Sampling</button>
                <div class="form-group" style="margin-top: 10px;">
                    <label class="form-label">GPS Points Collected: <span id="sampleCount" style="font-weight: 600;">0</span></label>
                </div>
                <div class="info-box warning">
                    <b>ğŸ“± GPS Tip:</b> Phone (cellular) GPS is more accurate than WiFi-only iPad. Use phone for field sampling, iPad for data review.
                </div>
            </div>
            
            <!-- Export Section -->
            <div class="panel-section" id="exportSection" style="display: none;">
                <div class="section-title">Data Export & Backup</div>
                <button class="btn btn-success" onclick="exportCSV()">ğŸ“Š Export Lab CSV</button>
                <div class="btn-group" style="margin-top: 8px;">
                    <button class="btn btn-outline" onclick="backupData()">ğŸ’¾ Backup All</button>
                    <button class="btn btn-outline" onclick="restoreData()">ğŸ“¥ Restore</button>
                </div>
                <button class="btn btn-outline" onclick="forceSync()" style="margin-top: 8px;">ğŸ”„ Force Sync</button>
                <div class="info-box info">
                    <b>â˜ï¸ Cloud Sync:</b> Your data syncs automatically across all devices. Works offline - syncs when reconnected.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Layer Controls -->
    <div class="layer-controls" id="layerControls">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="margin: 0;">Map Layers</h4>
            <button onclick="toggleLayerPanel()" style="background: none; border: none; cursor: pointer; font-size: 18px; color: #667eea; padding: 0;" id="layerToggleBtn">
                âˆ’
            </button>
        </div>
        <div id="layerContent">
            <div class="layer-toggle">
                <input type="checkbox" id="soilToggle" onchange="toggleSoilLayer()">
                <label for="soilToggle">Zone/Soil Data Overlay</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="boundaryToggle" checked onchange="toggleBoundaries()">
                <label for="boundaryToggle">Field Boundaries</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="sampleToggle" checked onchange="toggleSamples()">
                <label for="sampleToggle">Sample Points</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="satelliteToggle" checked onchange="toggleMapType()">
                <label for="satelliteToggle">Satellite View</label>
            </div>
            <hr style="margin: 10px 0;">
            <div class="file-upload">
                <input type="file" id="soilUpload" accept=".json,.geojson,.kml,.zip">
                <label for="soilUpload" class="file-upload-label">
                    ğŸ“ Load Zone/Soil Data
                </label>
            </div>
            <div style="margin-top: 5px; font-size: 11px; color: #666;" id="soilStatus">No zone/soil data loaded</div>
            <div style="margin-top: 3px; font-size: 10px; color: #999; font-style: italic;">Supports: GeoJSON, KML, or Zipped Shapefiles</div>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
        <span class="status-item">
            <span class="status-label">GPS:</span>
            <span class="status-value" id="gpsStatus">Waiting...</span>
        </span>
        <span class="status-item">
            <span class="status-label">Farm:</span>
            <span class="status-value" id="currentFarm">None</span>
        </span>
        <span class="status-item">
            <span class="status-label">Field:</span>
            <span class="status-value" id="currentField">None</span>
        </span>
    </div>
    
    <!-- Toolbar -->
    <div class="toolbar">
        <button class="tool-btn" onclick="toggleAllPanels()" title="Toggle Panels" style="background: #667eea; color: white;">â˜°</button>
        <button class="tool-btn" onclick="centerOnGPS()" title="Center on GPS">ğŸ“</button>
        <button class="tool-btn" id="dropPinBtn" onclick="dropPin()" title="Drop Sample Pin">ğŸ¯</button>
        <button class="tool-btn" onclick="zoomIn()" title="Zoom In">â•</button>
        <button class="tool-btn" onclick="zoomOut()" title="Zoom Out">â–</button>
        <button class="tool-btn" onclick="zoomToField()" title="Zoom to Field">ğŸ”</button>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Application JavaScript -->
    <script src="js/app.js"></script>

</body>
</html>